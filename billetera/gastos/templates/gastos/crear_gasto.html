{% extends "base.html" %}
{% load static %}
{% block title %}Crear Gasto - MoneyFlow Mirror{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="mb-6" aria-label="breadcrumb">
        <ol class="flex space-x-2 text-sm text-gray-500">
            <li><a href="{% url 'inicio_usuarios' %}" class="hover:text-primary transition-colors duration-200">Inicio</a></li>
            <li class="before:content-['/'] before:mx-2">
                <a href="{% url 'gastos:lista_gastos' %}" class="hover:text-primary transition-colors duration-200">Gastos</a>
            </li>
            <li class="before:content-['/'] before:mx-2 text-gray-900">Crear</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="text-center mb-8">
        <div class="w-16 h-16 bg-expense-light bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-3xl">üí∏</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Registrar Nuevo Gasto</h1>
        <p class="text-gray-600">Controla tus gastos de manera consciente e inteligente</p>
    </div>

    <!-- Form Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-expense text-white p-6 text-center">
            <h2 class="text-xl font-semibold">üí∏ Nuevo Gasto</h2>
        </div>
        
        <div class="p-6">
            <form method="post" class="space-y-6" novalidate>
                {% csrf_token %}
                
                <!-- Description Field -->
                <div>
                    <label for="{{ form.descripcion.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                        <span class="flex items-center">
                            <span class="mr-2">üè∑Ô∏è</span>
                            {{ form.descripcion.label }}
                            <span class="text-expense ml-1">*</span>
                        </span>
                    </label>
                    <input type="text" 
                           name="{{ form.descripcion.name }}" 
                           id="{{ form.descripcion.id_for_label }}"
                           class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-expense focus:border-expense transition-colors duration-200 font-medium"
                           placeholder="Ej: Compra en supermercado"
                           {% if form.descripcion.value %}value="{{ form.descripcion.value }}"{% endif %}
                           required>
                    {% if form.descripcion.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.descripcion.help_text }}</p>
                    {% endif %}
                    {% if form.descripcion.errors %}
                        <p class="mt-1 text-sm text-expense">{{ form.descripcion.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Tienda Field -->
                <div>
                    <label for="{{ form.tienda_nombre.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                        <span class="flex items-center">
                            <span class="mr-2">üìç</span>
                            {{ form.tienda_nombre.label }}
                        </span>
                    </label>
                    <input type="text" 
                           name="{{ form.tienda_nombre.name }}" 
                           id="{{ form.tienda_nombre.id_for_label }}"
                           list="tiendas-list"
                           autocomplete="off"
                           class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-expense focus:border-expense transition-colors duration-200 font-medium"
                           placeholder="Ej: Carrefour, Kiosco"
                           {% if form.tienda_nombre.value %}value="{{ form.tienda_nombre.value }}"{% endif %}>
                    <datalist id="tiendas-list">
                        {% for tienda in tiendas %}
                            <option value="{{ tienda.nombre }}">
                        {% endfor %}
                    </datalist>
                    {% if form.tienda_nombre.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.tienda_nombre.help_text }}</p>
                    {% endif %}
                    {% if form.tienda_nombre.errors %}
                        <p class="mt-1 text-sm text-expense">{{ form.tienda_nombre.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Date Field -->
                <div>
                    <label for="{{ form.fecha.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                        <span class="flex items-center">
                            <span class="mr-2">üìÖ</span>
                            {{ form.fecha.label }}
                        </span>
                    </label>
                    <input type="datetime-local" 
                           name="{{ form.fecha.name }}" 
                           id="{{ form.fecha.id_for_label }}"
                           class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-expense focus:border-expense transition-colors duration-200"
                           value="{% now 'Y-m-d\TH:i' %}">
                    {% if form.fecha.errors %}
                        <p class="mt-1 text-sm text-expense">{{ form.fecha.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Category Field -->
                <div>
                    <label for="{{ form.categoria.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                        <span class="flex items-center">
                            <span class="mr-2">üìÅ</span>
                            {{ form.categoria.label }}
                        </span>
                    </label>
                    <select name="{{ form.categoria.name }}" 
                            id="{{ form.categoria.id_for_label }}"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-expense focus:border-expense transition-colors duration-200">
                        <option value="">Selecciona una categor√≠a</option>
                        {% for choice in form.categoria.field.choices %}
                            {% if choice.0 %}
                                <option value="{{ choice.0 }}" {% if form.categoria.value == choice.0 %}selected{% endif %}>
                                    {{ choice.1 }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% if form.categoria.errors %}
                        <p class="mt-1 text-sm text-expense">{{ form.categoria.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Account Field -->
                <div>
                    <label for="{{ form.cuenta.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                        <span class="flex items-center">
                            <span class="mr-2">üí≥</span>
                            {{ form.cuenta.label }}
                        </span>
                    </label>
                    <select name="{{ form.cuenta.name }}" 
                            id="{{ form.cuenta.id_for_label }}"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-expense focus:border-expense transition-colors duration-200">
                        <option value="">Selecciona una cuenta (Opcional)</option>
                        {% for choice in form.cuenta.field.queryset %}
                            <option value="{{ choice.pk }}" {% if form.cuenta.value == choice.pk %}selected{% endif %}>
                                {{ choice.nombre }} ({{ choice.moneda.codigo }})
                            </option>
                        {% endfor %}
                    </select>
                    {% if form.cuenta.errors %}
                        <p class="mt-1 text-sm text-expense">{{ form.cuenta.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Quantity Field -->
                <div>
                    <label for="{{ form.cantidad.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                        <span class="flex items-center">
                            <span class="mr-2">üî¢</span>
                            {{ form.cantidad.label }}
                        </span>
                    </label>
                    <div class="flex items-center w-full md:w-1/3">
                        <button type="button" onclick="updateQuantity(-1)" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded-l-lg transition-colors text-gray-700 font-bold text-lg">-</button>
                        <input type="number" 
                               name="{{ form.cantidad.name }}" 
                               id="{{ form.cantidad.id_for_label }}"
                               class="w-full py-3 text-center border-y border-gray-300 focus:ring-0 font-numbers text-lg"
                               min="1"
                               value="{{ form.cantidad.value|default:1 }}"
                               required>
                        <button type="button" onclick="updateQuantity(1)" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded-r-lg transition-colors text-gray-700 font-bold text-lg">+</button>
                    </div>
                    {% if form.cantidad.errors %}
                        <p class="mt-1 text-sm text-expense">{{ form.cantidad.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Amount and Currency Fields -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label for="{{ form.monto.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                            <span class="flex items-center">
                                <span class="mr-2">üí∞</span>
                                {{ form.monto.label }}
                                <span class="text-expense ml-1">*</span>
                            </span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">$</span>
                            <input type="number" 
                                   name="{{ form.monto.name }}" 
                                   id="{{ form.monto.id_for_label }}"
                                   class="w-full pl-8 pr-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-expense focus:border-expense transition-colors duration-200 font-numbers text-lg"
                                   placeholder="0.00"
                                   step="0.01"
                                   min="0"
                                   {% if form.monto.value %}value="{{ form.monto.value }}"{% endif %}
                                   required>
                        </div>
                        {% if form.monto.help_text %}
                            <p class="mt-1 text-sm text-gray-500">{{ form.monto.help_text }}</p>
                        {% endif %}
                        {% if form.monto.errors %}
                            <p class="mt-1 text-sm text-expense">{{ form.monto.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.moneda.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                            <span class="flex items-center">
                                <span class="mr-2">üí±</span>
                                <span class="hidden md:inline">{{ form.moneda.label }}</span>
                                <span class="md:hidden">Moneda</span>
                            </span>
                        </label>
                        <select name="{{ form.moneda.name }}" 
                                id="{{ form.moneda.id_for_label }}"
                                class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-expense focus:border-expense transition-colors duration-200">
                            {% for choice in form.moneda.field.queryset %}
                                <option value="{{ choice.pk }}" {% if form.moneda.value == choice.pk %}selected{% endif %}>
                                    {{ choice.codigo }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if form.moneda.errors %}
                            <p class="mt-1 text-sm text-expense">{{ form.moneda.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="space-y-4 pt-6">
                    <button type="submit" 
                            class="w-full bg-expense hover:bg-expense-dark text-white font-medium px-6 py-4 rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md text-lg expense-pulse">
                        <span class="flex items-center justify-center">
                            <span class="mr-2">üí∏</span>
                            <span class="hidden sm:inline">Guardar Gasto</span>
                            <span class="sm:hidden">Guardar</span>
                        </span>
                    </button>
                    <p class="text-sm text-gray-500 text-center">
                        Al guardar, se registrar√° el gasto en tu historial financiero
                    </p>
                </div>
            </form>
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-6">
        <a href="{% url 'gastos:lista_gastos' %}" 
           class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-6 py-3 rounded-lg transition-colors duration-200 inline-flex items-center">
            <span class="mr-2">‚Üê</span>
            <span class="hidden sm:inline">Volver a la lista de gastos</span>
            <span class="sm:hidden">Volver</span>
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Format number input on blur
    const amountInput = document.querySelector('input[type="number"]');
    if (amountInput) {
        amountInput.addEventListener('blur', function() {
            if (this.value && !isNaN(this.value)) {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });
    }

    // Add success pulse animation on form submit
    const form = document.querySelector('form');
    const submitButton = document.querySelector('button[type="submit"]');
    
    if (form && submitButton) {
        form.addEventListener('submit', function(e) {
            if (form.checkValidity()) {
                submitButton.classList.add('expense-pulse');
            }
        });
    }
});

function updateQuantity(change) {
    const input = document.getElementById('{{ form.cantidad.id_for_label }}');
    let newValue = parseInt(input.value) + change;
    if (newValue < 1) newValue = 1;
    input.value = newValue;
}
</script>
{% endblock %}
